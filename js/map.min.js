/*! Radiografia_de_las_carceles 2014-11-02 */
var width=500,height=630,projection=d3.geo.transverseMercator().center([2.5,-38.5]).rotate([66,0]).scale(56.5*height/33).translate([width/2,height/2]),svg=d3.select("#map").append("svg").attr("width",width).attr("height",height),map=svg.append("g"),path=d3.geo.path().projection(projection),groupMap=map.append("g"),groupData={},radiusMultiplier={spf:.5,spp:.5};groupData.Provincias=map.append("g").attr("class","Provincias").style("opacity",1),groupData.Ciudades=map.append("g").attr("class","Ciudades").style("opacity",0).style("pointer-events","none");var radiusCalc=function(a,b){var c=a*Math.sqrt(b/Math.PI);return d3.svg.arc().outerRadius(c).innerRadius(c-c/3)},backBtn=d3.select("#back").on("click",function(){groupMap.select("path").on("click").apply(this,null)});queue().defer(d3.json,"data/argentina_indec.json?timestamp=201411010935").defer(d3.tsv,"data/condenados_procesados.tsv?timestamp=201411010935").awaitAll(function(a,b){a&&console.log(a),function(a,b,c){var d=topojson.feature(c,c.objects.provincias).features.sort(function(a){return"AMBA"==a.properties.administrative_area[0].id||"CAB"==a.properties.administrative_area[0].id?1:0});a.selectAll("undefined").data(d,function(a){return a.properties.administrative_area[0].id}).enter().append("path").attr("class",function(a){a.zoom=!a.properties.notzoom;var b=a.properties.administrative_area[0].name?a.properties.administrative_area[0].name.replace(/\s+/g,"_").toLowerCase():"notshow",c=a.properties.administrative_area[0].class||"",d=a.zoom?"zoomout":"";return"land "+c+" "+b+" "+d},!0).attr("d",function(a){switch(a.properties.administrative_area[0].id){case"TDF":a.centroid=b([-67.8515625,-54.43810280974017]);break;case"SAL":a.centroid=b([-65.2972412109375,-25.28443774698303]);break;default:a.centroid=path.centroid(a)}return path(a)}).on("click",function(b){if(!b||b&&b.zoom){d3.select("#tooltip").classed("hidden",!0);var c=path.bounds(b),d=.95/Math.max((c[1][0]-c[0][0])/width,(c[1][1]-c[0][1])/height),e=b?[-(c[1][0]+c[0][0])/2,-(c[1][1]+c[0][1])/2]:[-width/2,-height/2],f=500;backBtn.classed("hidden",!d),map.transition().duration(f).attr("transform","translate("+width/2+","+height/2+") scale("+(d||1)+") translate("+e+")"),a.selectAll("path").classed("zoomout",function(a){return a.zoom=!a.properties.notzoom&&b!==a,a.zoom}).classed("zoomin",function(a){return!a.properties.notzoom&&b==a}).transition().duration(f).style("stroke-width",function(){return d?1/d+"px":null}),groupData.Provincias.transition().duration(f).ease("cubic").style("opacity",function(){return b?0:1}),function(a,c){a.transition().style("pointer-events",function(){return b?"auto":"none"}).duration(f).ease("cubic").style("opacity",function(){return b?1:0}),a.selectAll("path").transition().duration(f).ease("cubic").attr("d",function(a){var e=b&&"amba"==b.properties.administrative_area[0].id.toLowerCase()?100:6,f=b?37e3/c/d/e:0,g=f?radiusCalc(f,a.data.total):null;return b?g(a):""}),a.selectAll("circle.select").transition().duration(f).ease("cubic").attr("r",function(){var a=b&&"amba"==b.properties.administrative_area[0].id.toLowerCase()?33:2,e=b?37e3/c/d/a:0,f=.5;return b?f*e:0}),a.selectAll("path").transition().duration(f).ease("cubic").attr("d",function(a){var e=b&&"amba"==b.properties.administrative_area[0].id.toLowerCase()?100:6,f=b?37e3/c/d/e:0,g=f?radiusCalc(f,a.data.total):null;return b?g(a):""}),a.selectAll("circle.pointer").on("mouseenter",function(a){a&&!function(b,c){c==a.Jurisdiccion.toLowerCase()&&(b.classed("spp","spp"==c).classed("spf","spf"==c),b.select("#presosTotales span").text(a.Total),b.select("#tooltip > h4").text(a.UbicaciÃ³n),b.select("#condenados > span:nth-child(2)").text(a.Condenados),b.select("#condenadosPorcentaje").text(function(){var b=a.Condenados,c=a.Total;return Math.round(b/c*100)+"%"}),b.select("#procesados > span:nth-child(2)").text(a.Procesados),b.select("#procesadosPorcentaje").text(function(){var b=a.Procesados,c=a.Total;return Math.round(b/c*100)+"%"}),b.classed("hidden",!1))}(d3.select("#tooltip"),d3.select("#formSelector input[type='radio']:checked").property("value"))}).on("mousemove",function(){!function(a){var b=d3.event.pageX+10,c=d3.event.pageY<710?d3.event.pageY+10:d3.event.pageY-10-a.node().clientHeight;a.style("top",c+"px").style("left",b+"px")}(d3.select("#tooltip"))}).on("mouseleave",function(){d3.select("#tooltip").classed("hidden",!0)}).transition().duration(f).ease("cubic").attr("r",function(a){var e=b&&"amba"==b.properties.administrative_area[0].id.toLowerCase()?33:3.5,f=b?37e3/c/d/e:0,g=f?radiusCalc(f,a.Total):0,h=g?g.innerRadius():0,i=g?g.outerRadius():0;return b?Math.max(h(),i())*f:0})}(groupData.Ciudades,path.area(b))}}).on("mouseenter",function(b){b.data&&!a.select("path.zoomin").node()&&!function(a,c){b.data[c]&&(a.classed("spp","spp"==c).classed("spf","spf"==c),a.select("#presosTotales span").text(b.data[c].Total),a.select("#tooltip > h4").text(b.properties.administrative_area[0].name),a.select("#condenados > span:nth-child(2)").text(b.data[c].Condenados),a.select("#condenadosPorcentaje").text(function(){var a=b.data[c].Condenados,d=b.data[c].Total;return Math.round(a/d*100)+"%"}),a.select("#procesados > span:nth-child(2)").text(b.data[c].Procesados),a.select("#procesadosPorcentaje").text(function(){var a=b.data[c].Procesados,d=b.data[c].Total;return Math.round(a/d*100)+"%"}),a.classed("hidden",!1))}(d3.select("#tooltip"),d3.select("#formSelector input[type='radio']:checked").property("value"))}).on("mousemove",function(){!function(a){var b=d3.event.pageX+10,c=d3.event.pageY<710?d3.event.pageY+10:d3.event.pageY-10-a.node().clientHeight;a.style("top",c+"px").style("left",b+"px")}(d3.select("#tooltip"))}).on("mouseleave",function(){d3.select("#tooltip").classed("hidden",!0)})}(groupMap,projection,b[0]),function(a,b,c){var d=d3.layout.pie().sort(function(a,b){return d3.ascending(a.type,b.type)}).value(function(a){return a.value}),e=function(a,b,c,d){var e=a.append("g").attr("class",function(a){return"circle "+a.Jurisdiccion.toLowerCase()});return e.append("circle").attr("class","select").attr("r",b),e.append("circle").datum(a.datum()).attr("class","pointer").attr("r",d.outerRadius()),e},f=function(a){return d3.select(a).datum().centroid},g={Provincias:d3.nest().key(function(a){return[a.Jurisdiccion,a.Provincia]}).rollup(function(a){return{Jurisdiccion:a[0].Jurisdiccion,Provincia:a[0].Provincia,Condenados:d3.sum(a,function(a){return a.Condenados}),Procesados:d3.sum(a,function(a){return a.Procesados})}}).entries(c).map(function(a){return a.values}),Ciudades:c};Object.keys(g).forEach(function(c){!function(a,g){g.sort(function(a,b){return parseInt(b.Condenados)+parseInt(b.Procesados)-(parseInt(a.Condenados)+parseInt(a.Procesados))}).forEach(function(g){g.Total=parseInt(g.Procesados)+parseInt(g.Condenados);var h=g.Jurisdiccion.toLowerCase(),i=g.geo_longitude&&g.geo_latitude?b([g.geo_longitude,g.geo_latitude]):f("path.land."+g.Provincia.replace(/\s+/g,"_").toLowerCase());!function(a,b){var f=0==parseInt(g.Total)?0:"Provincias"==c?1.5:.5;!function(a){a.append("path").attr("d",function(a){return a.value?b(a):""})}(a.selectAll(".arc").data(d([{type:"Procesados",value:parseInt(g.Procesados),total:parseInt(g.Total),domain:h},{type:"Condenados",value:parseInt(g.Condenados),total:parseInt(g.Total),domain:h}])).enter().append("g").attr("class",function(a){return a.data.type.toLowerCase()+" arc "+h})),e(a,f,a.datum(),b)}(a.append("g").datum(g).attr("transform","translate("+i[0]+","+i[1]+")").attr("id",g.id).attr("class","marker "+g.Provincia.toLowerCase().replace(/\s+/g,"_")).each(function(a){if("Provincias"==c&&h){var b=d3.select("path.land."+g.Provincia.toLowerCase().replace(/\s+/g,"_")).datum();b.data=b.data||{},b.data[h]=a}}),radiusCalc(radiusMultiplier[h],g.Total))})}(a[c],g[c],"Provincias"==c?30:1e3)})}(groupData,projection,b[1]),function(a){map.selectAll(".spp,.spf").classed("hidden",function(b){return(b.Jurisdiccion||b.data.domain).toLowerCase()!=a})}(d3.select("#formSelector input[type='radio']:checked").property("value"))}),d3.select("#back").on("click",function(){groupMap.select("path").on("click").apply(this,null)});var hideSppSpf=function(a){map.selectAll(".spf").classed("hidden",!a),map.selectAll(".spp").classed("hidden",a)};d3.select("#spf").on("click",function(){hideSppSpf(!0)}),d3.select("#spp").on("click",function(){hideSppSpf(!1)}),d3.select("#alerta").style("display","none");